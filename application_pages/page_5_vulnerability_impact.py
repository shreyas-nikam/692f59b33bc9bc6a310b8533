import streamlit as st
import matplotlib.pyplot as plt
import networkx as nx

def main():
    st.header("9. Simulating a Vulnerability")
    st.markdown("""
    Simulating a vulnerability is a powerful way to understand potential impacts and identify critical risk propagation paths. We will select a component and artificially increase its 'Known_Vulnerabilities_Score' to reflect a newly discovered, severe exploit (e.g., a zero-day exploit). This simulation will then trigger a re-evaluation of risks throughout the system.
    """)
    if not st.session_state.simulated_risk_graph.empty():
        st.markdown(f"Simulation performed: Component **'{st.session_state.vulnerable_component_id_input}'** was affected with a base impact score of **{st.session_state.base_impact_score_input}**. Risks have been propagated.")
        st.markdown("""
        By simulating a critical vulnerability, we've created a scenario to observe how such an event could escalate. This modified graph is now ready to show us the ripple effect across the entire AI system, which is invaluable for pre-emptive planning and incident response.
        """)

        st.header("10. Visualizing Vulnerability Propagation")
        st.markdown("""
        Visualizing the impact of a simulated vulnerability clearly demonstrates cascading effects. By comparing the graph before and after the simulation, we can identify which components are most affected and how risks propagate through the system's dependencies. Nodes will be color-coded based on their updated risk scores to immediately highlight highly impacted areas.
        """)
        fig, ax = plt.subplots(figsize=(14, 10))
        pos = nx.spring_layout(st.session_state.simulated_risk_graph, seed=42)

        risk_scores = [st.session_state.simulated_risk_graph.nodes[node].get('Component_Risk_Score', 0.0) for node in st.session_state.simulated_risk_graph.nodes()]
        
        cmap = plt.cm.get_cmap('RdYlGn_r')
        norm = plt.Normalize(vmin=0, vmax=15)
        node_colors = [cmap(norm(score)) for score in risk_scores]

        node_sizes = [score * 200 + 1000 for score in risk_scores]

        nx.draw_networkx_nodes(st.session_state.simulated_risk_graph, pos, node_color=node_colors, node_size=node_sizes, alpha=0.9, ax=ax)
        nx.draw_networkx_edges(st.session_state.simulated_risk_graph, pos, edgelist=st.session_state.simulated_risk_graph.edges(), edge_color='gray', arrowsize=20, ax=ax)
        nx.draw_networkx_labels(st.session_state.simulated_risk_graph, pos, font_size=8, font_weight='bold', ax=ax)

        ax.set_title("AI System Graph with Simulated Vulnerability Impact")
        ax.axis('off')

        sm = plt.cm.ScalarMappable(cmap=cmap, norm=norm)
        sm.set_array(risk_scores)
        cbar = plt.colorbar(sm, orientation='vertical', pad=0.02, ax=ax)
        cbar.set_label('Component Risk Score (0-15)')
        st.pyplot(fig)
        st.markdown("""
        This visualization offers a critical insight into the system's resilience and potential vulnerabilities. Risk Managers can clearly see which parts of the AI system are most exposed to a threat originating from a specific component, enabling them to prioritize mitigation strategies for critical paths.
        """)
    else:
        st.info("Run a vulnerability simulation using the sidebar controls to visualize the impact.")